import React, { useMemo, useState, useRef, useEffect } from 'react';
import './App.css';

function PersonaBuilder() {
  const [personas, setPersonas] = useState([]);
  const [activePersonaId, setActivePersonaId] = useState(null);
  const [draft, setDraft] = useState({
    name: '',
    description: '',
    demographics: '',
    behaviors: '',
    goals: '',
    painPoints: '',
    dataSources: { yourData: true, ourData: true, industryData: true },
    tags: [],
    attributes: {
      ageRange: [],
      spendLevel: [],
      geography: [],
      productType: [],
      cardTier: [],
      loyaltyTier: [],
    },
  });
  const [importPreview, setImportPreview] = useState(null);
  const [assignmentIndex, setAssignmentIndex] = useState({
    bookings: {},
    functions: {},
    rewards: {},
  });
  const [activeTab, setActiveTab] = useState('library');
  const [showCreateModal, setShowCreateModal] = useState(false);
  const fileInputRef = useRef(null);

  const attributeCatalog = useMemo(() => ({
    ageRange: ['18-25', '26-35', '36-45', '46-60', '60+'],
    spendLevel: ['Low', 'Medium', 'High', 'VIP'],
    geography: ['USA', 'Brazil', 'UK', 'EU', 'APAC', 'MEA'],
    productType: ['Flights', 'Hotels', 'Packages', 'Experiences'],
    cardTier: ['Silver', 'Gold', 'Platinum', 'Diamond'],
    loyaltyTier: ['Basic', 'Plus', 'Elite', 'Premier'],
  }), []);

  const [attributeFilters, setAttributeFilters] = useState({
    ageRange: [],
    spendLevel: [],
    geography: [],
    productType: [],
    cardTier: [],
    loyaltyTier: [],
  });

  // Seed example personas on first load if none exist
  useEffect(() => {
    if (personas.length === 0) {
      const now = new Date().toISOString();
      const seeds = [
        {
          id: crypto.randomUUID(),
          name: 'Young Professionals Brazil Platinum',
          description: '18â€“35yrs, Brazil-based, Platinum cardholders with frequent lounge usage.',
          tags: ['Young Professionals', 'Brazil', 'Platinum'],
          dataSources: { yourData: true, ourData: true, industryData: true },
          attributes: {
            ageRange: ['18-25', '26-35'],
            geography: ['Brazil'],
            cardTier: ['Platinum'],
            spendLevel: ['High'],
            productType: ['Flights'],
            loyaltyTier: ['Elite'],
          },
          createdAt: now,
          updatedAt: now,
          history: [],
        },
        {
          id: crypto.randomUUID(),
          name: 'Business Travelers USA Gold',
          description: 'Frequent domestic flyers, USA, Gold tier, mid-high spend.',
          tags: ['Business', 'USA', 'Gold'],
          dataSources: { yourData: true, ourData: true, industryData: true },
          attributes: {
            ageRange: ['36-45', '46-60'],
            geography: ['USA'],
            cardTier: ['Gold'],
            spendLevel: ['Medium', 'High'],
            productType: ['Flights', 'Hotels'],
            loyaltyTier: ['Plus'],
          },
          createdAt: now,
          updatedAt: now,
          history: [],
        },
        {
          id: crypto.randomUUID(),
          name: 'Luxury Leisure EU Diamond',
          description: 'EU leisure travelers prioritizing experiences & premium stays.',
          tags: ['Leisure', 'EU', 'Diamond'],
          dataSources: { yourData: true, ourData: true, industryData: true },
          attributes: {
            ageRange: ['36-45', '46-60'],
            geography: ['EU'],
            cardTier: ['Diamond'],
            spendLevel: ['VIP'],
            productType: ['Experiences', 'Hotels'],
            loyaltyTier: ['Premier'],
          },
          createdAt: now,
          updatedAt: now,
          history: [],
        },
      ];
      setPersonas(seeds);
    }
  }, []);

  function toggleAttribute(key, value) {
    setAttributeFilters(prev => {
      const prevValues = prev[key] || [];
      const nextValues = prevValues.includes(value)
        ? prevValues.filter(v => v !== value)
        : prevValues.concat(value);
      return { ...prev, [key]: nextValues };
    });
  }

  function clearAttributes() {
    setAttributeFilters({
      ageRange: [],
      spendLevel: [],
      geography: [],
      productType: [],
      cardTier: [],
      loyaltyTier: [],
    });
  }

  // Mock dataset for preview population size
  const mockUsers = useMemo(() => [
    { id: 'u1', ageRange: '18-25', spendLevel: 'Low', geography: 'Brazil', productType: 'Flights', cardTier: 'Silver', loyaltyTier: 'Basic' },
    { id: 'u2', ageRange: '26-35', spendLevel: 'High', geography: 'USA', productType: 'Hotels', cardTier: 'Platinum', loyaltyTier: 'Elite' },
    { id: 'u3', ageRange: '36-45', spendLevel: 'Medium', geography: 'EU', productType: 'Packages', cardTier: 'Gold', loyaltyTier: 'Plus' },
    { id: 'u4', ageRange: '26-35', spendLevel: 'VIP', geography: 'Brazil', productType: 'Flights', cardTier: 'Diamond', loyaltyTier: 'Premier' },
    { id: 'u5', ageRange: '46-60', spendLevel: 'High', geography: 'UK', productType: 'Experiences', cardTier: 'Platinum', loyaltyTier: 'Elite' },
    { id: 'u6', ageRange: '18-25', spendLevel: 'Medium', geography: 'APAC', productType: 'Flights', cardTier: 'Gold', loyaltyTier: 'Plus' },
    { id: 'u7', ageRange: '60+', spendLevel: 'Low', geography: 'MEA', productType: 'Hotels', cardTier: 'Silver', loyaltyTier: 'Basic' },
    { id: 'u8', ageRange: '36-45', spendLevel: 'High', geography: 'USA', productType: 'Flights', cardTier: 'Platinum', loyaltyTier: 'Elite' },
  ], []);

  function matchesFilters(user) {
    const keys = Object.keys(attributeFilters);
    for (const key of keys) {
      const selected = attributeFilters[key];
      if (selected && selected.length > 0) {
        if (!selected.includes(user[key])) return false;
      }
    }
    return true;
  }

  const previewCount = useMemo(() => mockUsers.filter(matchesFilters).length, [mockUsers, attributeFilters]);

  const activePersona = useMemo(
    () => personas.find(p => p.id === activePersonaId) || null,
    [personas, activePersonaId]
  );

  function countPopulationForPersona(persona) {
    const attrs = persona.attributes || {};
    const keys = Object.keys(attrs);
    return mockUsers.filter(u => {
      for (const key of keys) {
        const sel = attrs[key];
        if (Array.isArray(sel) && sel.length > 0) {
          if (!sel.includes(u[key])) return false;
        }
      }
      return true;
    }).length;
  }

  function resetDraft() {
    setDraft({
      name: '',
      description: '',
      demographics: '',
      behaviors: '',
      goals: '',
      painPoints: '',
      dataSources: { yourData: true, ourData: true, industryData: true },
      tags: [],
      attributes: {
        ageRange: [],
        spendLevel: [],
        geography: [],
        productType: [],
        cardTier: [],
        loyaltyTier: [],
      },
    });
    clearAttributes();
  }

  function handleSavePersona() {
    if (!draft.name.trim()) return;
    const now = new Date().toISOString();
    const personaPayload = {
      ...draft,
      attributes: attributeFilters,
      updatedAt: now,
    };
    if (activePersona) {
      setPersonas(prev => prev.map(p => {
        if (p.id !== activePersona.id) return p;
        const prevSnapshot = { ...p };
        delete prevSnapshot.history;
        const nextHistory = Array.isArray(p.history) ? p.history.concat(prevSnapshot) : [prevSnapshot];
        return { ...p, ...personaPayload, history: nextHistory };
      }));
    } else {
      setPersonas(prev => prev.concat({ id: crypto.randomUUID(), createdAt: now, history: [], ...personaPayload }));
    }
    resetDraft();
    setActivePersonaId(null);
    setShowCreateModal(false);
  }

  function handleEditPersona(id) {
    const persona = personas.find(p => p.id === id);
    if (!persona) return;
    setActivePersonaId(id);
    setDraft({
      name: persona.name,
      description: persona.description,
      demographics: persona.demographics,
      behaviors: persona.behaviors,
      goals: persona.goals,
      painPoints: persona.painPoints,
      dataSources: persona.dataSources || { yourData: true, ourData: true, industryData: true },
      tags: Array.isArray(persona.tags) ? persona.tags : [],
      attributes: persona.attributes || {
        ageRange: [],
        spendLevel: [],
        geography: [],
        productType: [],
        cardTier: [],
        loyaltyTier: [],
      },
    });
    setAttributeFilters(persona.attributes || {
      ageRange: [],
      spendLevel: [],
      geography: [],
      productType: [],
      cardTier: [],
      loyaltyTier: [],
    });
    setShowCreateModal(true);
  }

  function handleDeletePersona(id) {
    setPersonas(prev => prev.filter(p => p.id !== id));
    if (activePersonaId === id) {
      resetDraft();
      setActivePersonaId(null);
    }
  }

  function handleImport(fileText) {
    try {
      const parsed = JSON.parse(fileText);
      const list = Array.isArray(parsed) ? parsed : [parsed];
      const normalized = list.map(p => ({
        id: p.id || crypto.randomUUID(),
        name: p.name || 'Untitled Persona',
        description: p.description || '',
        demographics: p.demographics || '',
        behaviors: p.behaviors || '',
        goals: p.goals || '',
        painPoints: p.painPoints || '',
        dataSources: p.dataSources || { yourData: true, ourData: true, industryData: true },
        tags: Array.isArray(p.tags) ? p.tags : [],
        attributes: p.attributes || {
          ageRange: [],
          spendLevel: [],
          geography: [],
          productType: [],
          cardTier: [],
          loyaltyTier: [],
        },
        history: Array.isArray(p.history) ? p.history : [],
        createdAt: p.createdAt || new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      }));
      setImportPreview(normalized);
    } catch (e) {
      alert('Invalid JSON file');
    }
  }

  function commitImport() {
    if (Array.isArray(importPreview) && importPreview.length) {
      setPersonas(prev => {
        const existingByName = new Map(prev.map(p => [p.name, p]));
        const merged = [...prev];
        importPreview.forEach(p => {
          const existing = existingByName.get(p.name);
          if (existing) {
            const updated = { ...existing, ...p, id: existing.id, updatedAt: new Date().toISOString() };
            const idx = merged.findIndex(m => m.id === existing.id);
            merged[idx] = updated;
          } else {
            merged.push(p);
          }
        });
        return merged;
      });
      setImportPreview(null);
    }
  }

  function triggerFilePicker() {
    fileInputRef.current?.click();
  }

  function onFilePicked(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => handleImport(String(reader.result || ''));
    reader.readAsText(file);
    e.target.value = '';
  }

  function aiSuggestPersonaImprovements(persona) {
    const suggestions = [
      'Consider narrowing demographics to top-performing age groups.',
      'Incorporate loyalty tier as a key behavioral segment.',
      'Add industry trend: increased interest in wellness lounges.',
    ];
    alert(`AI Suggestions for ${persona.name}:\n\n- ${suggestions.join('\n- ')}`);
  }

  function aiSuggestAssignmentOptimizations(persona) {
    const ideas = [
      'Increase assignment to Upsell Function A for premium travelers.',
      'Test cross-sell Function C for bookings with long layovers.',
      'Bundle Reward Package Silver+ for mid-tier spenders.',
    ];
    alert(`AI Assignment Ideas for ${persona.name}:\n\n- ${ideas.join('\n- ')}`);
  }

  function handleTagsInputChange(e) {
    const raw = e.target.value;
    const parts = raw.split(',').map(t => t.trim()).filter(Boolean);
    setDraft(prev => ({ ...prev, tags: parts }));
  }

  function viewHistory(persona) {
    const hist = Array.isArray(persona.history) ? persona.history : [];
    if (!hist.length) {
      alert('No history yet for this persona.');
      return;
    }
    const lines = hist.map((h, idx) => {
      const ts = h.updatedAt || h.createdAt;
      const when = ts ? new Date(ts).toLocaleString() : `Version ${idx + 1}`;
      return `${idx + 1}. ${when} â€” ${h.name || persona.name}`;
    });
    alert(`History for ${persona.name}:\n\n${lines.join('\n')}`);
  }

  function TabNav() {
    const tabs = [
      { id: 'library', label: 'Library', icon: 'ðŸ“š', description: 'View all personas' },
      { id: 'insights', label: 'Assignment & Insights', icon: 'ðŸ“ˆ', description: 'Track & analyze' },
    ];
    return (
      <div className="settings-tabs">
        {tabs.map(tab => (
          <button
            key={tab.id}
            className={`tab-button ${activeTab === tab.id ? 'active' : ''}`}
            onClick={() => setActiveTab(tab.id)}
          >
            <span className="tab-icon">{tab.icon}</span>
            <div className="tab-text">
              <span className="tab-label">{tab.label}</span>
              <span className="tab-description">{tab.description}</span>
            </div>
          </button>
        ))}
      </div>
    );
  }

  function CreatePersonaModal() {
    if (!showCreateModal) return null;
    return (
      <div className="fullscreen-overlay" style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', zIndex: 1000 }}>
        <div className="fullscreen-modal" style={{ position: 'fixed', inset: 0, background: 'var(--brand-white)', padding: '24px 0', overflowY: 'auto' }}>
          <div className="section-content">
            <div className="metrics-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h2 className="section-title" style={{ margin: 0 }}>{activePersona ? 'Edit Persona' : 'Create Persona'}</h2>
              <div>
                <button className="btn secondary" onClick={() => { setShowCreateModal(false); setActivePersonaId(null); }}>Close</button>
              </div>
            </div>

            <div className="form-grid persona-form-grid">
              <label>
                <span>Name</span>
                <input className="form-input" value={draft.name} onChange={e => setDraft({ ...draft, name: e.target.value })} placeholder="e.g., Young Professionals Brazil Platinum" />
              </label>
              <label>
                <span>Description</span>
                <textarea className="form-input" value={draft.description} onChange={e => setDraft({ ...draft, description: e.target.value })} placeholder="Short overview" />
              </label>
              <label>
                <span>Tags</span>
                <input className="form-input" value={draft.tags.join(', ')} onChange={handleTagsInputChange} placeholder="e.g., Young Professionals, Brazil, Platinum" />
              </label>
              <fieldset className="inline-options persona-inline-options">
                <legend>Data Sources</legend>
                <label><input type="checkbox" checked={draft.dataSources.yourData} onChange={e => setDraft({ ...draft, dataSources: { ...draft.dataSources, yourData: e.target.checked } })} /> Your Data</label>
                <label><input type="checkbox" checked={draft.dataSources.ourData} onChange={e => setDraft({ ...draft, dataSources: { ...draft.dataSources, ourData: e.target.checked } })} /> Our Data</label>
                <label><input type="checkbox" checked={draft.dataSources.industryData} onChange={e => setDraft({ ...draft, dataSources: { ...draft.dataSources, industryData: e.target.checked } })} /> Industry Data</label>
              </fieldset>
            </div>

            <div className="analytics-section" style={{ paddingTop: 0 }}>
              <h3 className="section-title" style={{ fontSize: 16 }}>Attribute Selection</h3>
              <div className="metrics-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
                <div>
                  <h4>Age Range</h4>
                  <div className="inline-options">
                    {attributeCatalog.ageRange.map(v => (
                      <label key={v}><input type="checkbox" checked={attributeFilters.ageRange.includes(v)} onChange={() => toggleAttribute('ageRange', v)} /> {v}</label>
                    ))}
                  </div>
                </div>
                <div>
                  <h4>Spend Level</h4>
                  <div className="inline-options">
                    {attributeCatalog.spendLevel.map(v => (
                      <label key={v}><input type="checkbox" checked={attributeFilters.spendLevel.includes(v)} onChange={() => toggleAttribute('spendLevel', v)} /> {v}</label>
                    ))}
                  </div>
                </div>
                <div>
                  <h4>Geography</h4>
                  <div className="inline-options">
                    {attributeCatalog.geography.map(v => (
                      <label key={v}>
                        <input type="checkbox" checked={attributeFilters.geography.includes(v)} onChange={() => toggleAttribute('geography', v)} /> {v}
                      </label>
                    ))}
                  </div>
                </div>
                <div>
                  <h4>Product Type</h4>
                  <div className="inline-options">
                    {attributeCatalog.productType.map(v => (
                      <label key={v}><input type="checkbox" checked={attributeFilters.productType.includes(v)} onChange={() => toggleAttribute('productType', v)} /> {v}</label>
                    ))}
                  </div>
                </div>
                <div>
                  <h4>Card Tier</h4>
                  <div className="inline-options">
                    {attributeCatalog.cardTier.map(v => (
                      <label key={v}><input type="checkbox" checked={attributeFilters.cardTier.includes(v)} onChange={() => toggleAttribute('cardTier', v)} /> {v}</label>
                    ))}
                  </div>
                </div>
                <div>
                  <h4>Loyalty Tier</h4>
                  <div className="inline-options">
                    {attributeCatalog.loyaltyTier.map(v => (
                      <label key={v}><input type="checkbox" checked={attributeFilters.loyaltyTier.includes(v)} onChange={() => toggleAttribute('loyaltyTier', v)} /> {v}</label>
                    ))}
                  </div>
                </div>
              </div>
              <div className="actions" style={{ marginTop: 12 }}>
                <button onClick={clearAttributes} className="btn secondary">Clear Attributes</button>
                <span className="chip" style={{ marginLeft: 8 }}>Preview Population: {previewCount}</span>
              </div>
            </div>

            <div className="actions">
              <button onClick={handleSavePersona} className="btn primary">{activePersona ? 'Save Changes' : 'Create Persona'}</button>
              <button onClick={() => { resetDraft(); setActivePersonaId(null); setShowCreateModal(false); }} className="btn secondary">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="dashboard-container">
      <div className="dashboard-header">
        <h1>Persona Builder</h1>
        <p className="dashboard-subtitle">Build and manage personas using your data, our data, and industry data.</p>
      </div>

      <div className="section-content">
        <TabNav />

        {activeTab === 'library' && (
          <section className="analytics-section">
            <div className="preview-box" style={{ paddingTop: 16 }}>
              <div className="metrics-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <h2 className="section-title" style={{ margin: 0 }}>Persona Library</h2>
                <div>
                  <button className="btn primary" onClick={() => { resetDraft(); setActivePersonaId(null); setShowCreateModal(true); }}>Create Persona</button>
                  <button className="btn secondary" onClick={triggerFilePicker} style={{ marginLeft: 8 }}>Import Persona</button>
                  <input ref={fileInputRef} type="file" accept="application/json" onChange={onFilePicked} style={{ display: 'none' }} />
                </div>
              </div>
              {personas.length === 0 && <p className="page-subtitle" style={{ margin: 0 }}>No personas yet. Use Create or Import to get started.</p>}
              <div className="programs-grid" style={{ marginTop: 12 }}>
                {personas.map(p => (
                  <div key={p.id} className="program-card">
                    <div className="program-header">
                      <div className="program-info">
                        <h4>{p.name}</h4>
                        <p>{p.description || 'â€”'}</p>
                      </div>
                      <div className="program-meta">
                        <span className="chip chip-outline">Pop: {countPopulationForPersona(p)}</span>
                        <span className="chip chip-outline">Updated {new Date(p.updatedAt).toLocaleString()}</span>
                      </div>
                    </div>
                    <div className="program-details">
                      <div className="detail-row"><span className="detail-label">Tags:</span><span className="detail-value">{Array.isArray(p.tags) && p.tags.length ? p.tags.join(', ') : 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">Attributes:</span><span className="detail-value">{p.attributes ? Object.entries(p.attributes).flatMap(([k, vals]) => (vals && vals.length ? [`${k}: ${vals.join('/')}`] : [])).join(' | ') || 'â€”' : 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">Demographics:</span><span className="detail-value">{p.demographics || 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">Behaviors:</span><span className="detail-value">{p.behaviors || 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">Goals:</span><span className="detail-value">{p.goals || 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">Pain Points:</span><span className="detail-value">{p.painPoints || 'â€”'}</span></div>
                      <div className="detail-row"><span className="detail-label">History:</span><span className="detail-value">{Array.isArray(p.history) ? p.history.length : 0} versions</span></div>
                    </div>
                    <div className="program-actions">
                      <button onClick={() => handleEditPersona(p.id)} className="action-btn secondary">Edit</button>
                      <button onClick={() => aiSuggestPersonaImprovements(p)} className="action-btn secondary">AI Improve</button>
                      <button onClick={() => aiSuggestAssignmentOptimizations(p)} className="action-btn secondary">AI Assignments</button>
                      <button onClick={() => viewHistory(p)} className="action-btn secondary">View History</button>
                      <button onClick={() => alert('Navigate to Benefits Mgmt with persona context') } className="action-btn secondary">Open Benefits</button>
                      <button onClick={() => alert('Navigate to Engagement Mgmt with persona context') } className="action-btn secondary">Open Engagement</button>
                      <button onClick={() => handleDeletePersona(p.id)} className="action-btn secondary">Delete</button>
                    </div>
                  </div>
                ))}
              </div>

              {Array.isArray(importPreview) && importPreview.length > 0 && (
                <div className="preview-box" style={{ marginTop: 16 }}>
                  <div className="preview-title">Import Preview</div>
                  <div className="preview-content">
                    <div className="programs-grid">
                      {importPreview.map(p => (
                        <div key={p.id} className="program-card">
                          <div className="program-header">
                            <div className="program-info">
                              <h4>{p.name}</h4>
                              <p>{p.description || 'â€”'}</p>
                            </div>
                            <div className="program-meta">
                              <span className="chip chip-outline">Sources: {Object.entries(p.dataSources || {}).filter(([, v]) => !!v).map(([k]) => k).join(', ') || 'None'}</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="modal-footer" style={{ padding: 0, borderTop: 'none', marginTop: 12 }}>
                    <button onClick={commitImport} className="btn primary">Import</button>
                    <button onClick={() => setImportPreview(null)} className="btn secondary">Cancel</button>
                  </div>
                </div>
              )}

              <CreatePersonaModal />
            </div>
          </section>
        )}

        {activeTab === 'insights' && (
          <section className="analytics-section">
            <div className="preview-box" style={{ paddingTop: 16 }}>
              <h2 className="section-title">Assignment Tracking & Insights</h2>
              <p className="page-subtitle" style={{ margin: '0 0 12px 0' }}>Track where personas are assigned and view insights (placeholders).</p>
              <div className="metrics-grid" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
                <div>
                  <h3>Bookings</h3>
                  <p className="page-subtitle" style={{ margin: 0 }}>Coming soon: View bookings tagged with personas.</p>
                </div>
                <div>
                  <h3>Upsell / Cross-sell Functions</h3>
                  <p className="page-subtitle" style={{ margin: 0 }}>Coming soon: See which functions target each persona.</p>
                </div>
                <div>
                  <h3>Reward Packages</h3>
                  <p className="page-subtitle" style={{ margin: 0 }}>Coming soon: See reward packages linked to personas.</p>
                </div>
              </div>
            </div>
          </section>
        )}
      </div>
    </div>
  );
}

export default PersonaBuilder; 